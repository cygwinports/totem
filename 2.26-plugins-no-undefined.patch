--- origsrc/totem-2.26.1/configure.in	2009-04-01 14:56:45.000000000 -0500
+++ src/totem-2.26.1/configure.in	2009-04-19 17:23:26.968125000 -0500
@@ -846,6 +846,22 @@ AC_SUBST([AM_CFLAGS])
 AC_SUBST([AM_CXXFLAGS])
 AC_SUBST([AM_LDFLAGS])
 
+dnl ================================================================
+dnl Win32 plugin support
+dnl ================================================================
+case "$host_os" in
+	cygwin*|mingw*)
+		platform_win32=yes
+		win32_plugin_ldflags="-no-undefined -Wl,\$(top_builddir)/src/libtotem.a"
+		;;
+	*)
+		platform_win32=no
+		win32_plugin_ldflags=
+		;;
+esac
+AM_CONDITIONAL(PLATFORM_WIN32, test "x$platform_win32" = "xyes")
+AC_SUBST(win32_plugin_ldflags)
+
 AC_OUTPUT([
 Makefile
 totem.spec
--- origsrc/totem-2.26.1/lib/Makefile.am	2009-03-16 05:40:06.000000000 -0500
+++ src/totem-2.26.1/lib/Makefile.am	2009-04-19 17:23:27.030625000 -0500
@@ -27,6 +27,7 @@ libtotemscrsaver_la_LDFLAGS =				\
 	$(AM_LDFLAGS)
 
 libtotemscrsaver_la_LIBADD =				\
+	$(GTK_LIBS)						\
 	$(DBUS_LIBS)					\
 	$(XTEST_LIBS)
 
--- origsrc/totem-2.26.1/src/Makefile.am	2009-03-16 05:40:05.000000000 -0500
+++ src/totem-2.26.1/src/Makefile.am	2009-04-19 20:55:12.327500000 -0500
@@ -1,4 +1,4 @@
-SUBDIRS = plugins backend
+SUBDIRS = backend . plugins
 
 bin_PROGRAMS = totem totem-video-thumbnailer totem-video-indexer totem-audio-preview
 libexec_PROGRAMS =
@@ -18,7 +18,7 @@ common_defines = \
 	-DLOGO_PATH=DATADIR\"\"G_DIR_SEPARATOR_S\"totem\"G_DIR_SEPARATOR_S\"totem_logo.png\"	\
 	$(DISABLE_DEPRECATED)
 
-modules_flags = -export_dynamic -avoid-version -module -no-undefined
+modules_flags = -export-dynamic -avoid-version -module -no-undefined
 
 # Bacon message connection ltlibrary
 
@@ -42,6 +42,11 @@ libbaconmessageconnection_la_CFLAGS = \
 libbaconmessageconnection_la_LDFLAGS = \
 	$(AM_LDFLAGS)
 
+plugins/libtotemmodule.la:
+	cd $(@D) ; $(MAKE) $(@F)
+
+plugins/properties/libbaconvideowidgetproperties.la:
+	cd $(@D) ; $(MAKE) $(@F)
 
 BACONDIR=$(srcdir)/../../libbacon/src
 regenerate-built-sources:
@@ -206,6 +211,11 @@ totem_CFLAGS = \
 totem_LDFLAGS = \
 	$(AM_LDFLAGS)
 
+if PLATFORM_WIN32
+totem_LDFLAGS += \
+	-Wl,--export-all-symbols -Wl,--out-implib,libtotem.a
+endif
+
 totem_LDADD =						\
 	libtotem_main.la				\
 	$(DEPENDENCY_LIBS)				\
@@ -308,8 +318,8 @@ test_properties_page_LDFLAGS = \
 	$(AM_LDFLAGS)
 
 test_properties_page_LDADD = 					\
-	backend/libbaconvideowidget.la				\
 	plugins/properties/libbaconvideowidgetproperties.la	\
+	backend/libbaconvideowidget.la				\
 	libtotem_player.la					\
 	$(DEPENDENCY_LIBS)					\
 	$(NAUTILUS_LIBS)					\
--- origsrc/totem-2.26.1/src/backend/Makefile.am	2009-03-16 05:40:03.000000000 -0500
+++ src/totem-2.26.1/src/backend/Makefile.am	2009-04-19 18:39:25.577500000 -0500
@@ -67,6 +67,7 @@ libbaconvideowidget_la_LIBADD =	\
 	$(XVIDMODE_LIBS)	\
 	$(MM_LIBS)		\
 	$(GST_LIBS)		\
+	$(GTK_LIBS)		\
 	$(EXTRA_BACKEND_LIBS)	\
 	$(X_LIBS)		\
 	$(MISSING_PLUGINS_LIBS)
--- origsrc/totem-2.26.1/src/plugins/bemused/Makefile.am	2009-03-16 05:40:03.000000000 -0500
+++ src/totem-2.26.1/src/plugins/bemused/Makefile.am	2009-04-19 17:23:56.015000000 -0500
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/bemused
 plugin_LTLIBRARIES = libbemused.la
--- origsrc/totem-2.26.1/src/plugins/brasero-disc-recorder/Makefile.am	2009-03-16 05:40:03.000000000 -0500
+++ src/totem-2.26.1/src/plugins/brasero-disc-recorder/Makefile.am	2009-04-19 17:24:05.936875000 -0500
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/brasero-disc-recorder
 plugin_LTLIBRARIES = libbrasero-disc-recorder.la
--- origsrc/totem-2.26.1/src/plugins/galago/Makefile.am	2009-03-16 05:40:04.000000000 -0500
+++ src/totem-2.26.1/src/plugins/galago/Makefile.am	2009-04-19 17:23:27.108750000 -0500
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/galago
 plugin_LTLIBRARIES = libtgp.la
--- origsrc/totem-2.26.1/src/plugins/gromit/Makefile.am	2009-03-16 05:40:04.000000000 -0500
+++ src/totem-2.26.1/src/plugins/gromit/Makefile.am	2009-04-19 17:23:27.171250000 -0500
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/gromit
 plugin_LTLIBRARIES = libgromit.la
@@ -22,7 +22,7 @@ common_defines = \
 
 libgromit_la_SOURCES = totem-gromit.c
 libgromit_la_LDFLAGS = $(modules_flags)
-libgromit_la_LIBADD = 
+libgromit_la_LIBADD = $(DBUS_LIBS)
 libgromit_la_CPPFLAGS = $(common_defines)
 
 libgromit_la_CFLAGS = \
--- origsrc/totem-2.26.1/src/plugins/lirc/Makefile.am	2009-03-16 05:40:04.000000000 -0500
+++ src/totem-2.26.1/src/plugins/lirc/Makefile.am	2009-04-19 17:23:27.202500000 -0500
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/lirc
 plugin_LTLIBRARIES = liblirc.la
--- origsrc/totem-2.26.1/src/plugins/media-player-keys/Makefile.am	2009-03-16 05:40:04.000000000 -0500
+++ src/totem-2.26.1/src/plugins/media-player-keys/Makefile.am	2009-04-19 17:23:27.265000000 -0500
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/media-player-keys
 plugin_LTLIBRARIES = libmedia_player_keys.la
--- origsrc/totem-2.26.1/src/plugins/ontop/Makefile.am	2009-03-16 05:40:03.000000000 -0500
+++ src/totem-2.26.1/src/plugins/ontop/Makefile.am	2009-04-19 17:23:27.296250000 -0500
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/ontop
 plugin_LTLIBRARIES = libontop.la
@@ -22,7 +22,7 @@ common_defines = \
 
 libontop_la_SOURCES = totem-ontop.c
 libontop_la_LDFLAGS = $(modules_flags)
-libontop_la_LIBADD = $(top_builddir)/lib/libtotemscrsaver.la
+libontop_la_LIBADD = $(top_builddir)/lib/libtotemscrsaver.la $(top_builddir)/src/backend/libbaconvideowidget.la
 libontop_la_CPPFLAGS = $(common_defines)
 
 libontop_la_CFLAGS = \
--- origsrc/totem-2.26.1/src/plugins/properties/Makefile.am	2009-03-16 05:40:04.000000000 -0500
+++ src/totem-2.26.1/src/plugins/properties/Makefile.am	2009-04-19 17:23:27.358750000 -0500
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/properties
 plugin_LTLIBRARIES = libmovie-properties.la
@@ -24,7 +24,7 @@ common_defines = \
 
 libmovie_properties_la_SOURCES = totem-movie-properties.c
 libmovie_properties_la_LDFLAGS = $(modules_flags)
-libmovie_properties_la_LIBADD = libbaconvideowidgetproperties.la
+libmovie_properties_la_LIBADD = libbaconvideowidgetproperties.la $(top_builddir)/src/backend/libbaconvideowidget.la $(GTK_LIBS)
 libmovie_properties_la_CPPFLAGS = $(common_defines)
 
 libmovie_properties_la_CFLAGS = \
--- origsrc/totem-2.26.1/src/plugins/publish/Makefile.am	2009-03-16 05:40:04.000000000 -0500
+++ src/totem-2.26.1/src/plugins/publish/Makefile.am	2009-04-19 17:23:27.405625000 -0500
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/publish
 plugin_LTLIBRARIES = libpublish.la
--- origsrc/totem-2.26.1/src/plugins/sample-vala/Makefile.am	2009-03-16 05:40:04.000000000 -0500
+++ src/totem-2.26.1/src/plugins/sample-vala/Makefile.am	2009-04-19 17:23:27.421250000 -0500
@@ -7,7 +7,7 @@ plugin_in_files = sample-vala.totem-plug
 %.totem-plugin: %.totem-plugin.in $(INTLTOOL_MERGE) $(wildcard $(top_srcdir)/po/*po) ; $(INTLTOOL_MERGE) $(top_srcdir)/po $< $@ -d -u -c $(top_builddir)/po/.intltool-merge-cache
 
 if ENABLE_VALA
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugin_LTLIBRARIES = libsample-vala.la
 # override to _not_ install the test plugins
@@ -29,6 +29,7 @@ common_defines = \
 
 nodist_libsample_vala_la_SOURCES = $(BUILT_SOURCES)
 libsample_vala_la_LDFLAGS = $(modules_flags)
+libsample_vala_la_LIBADD = $(VALA_LIBS)
 libsample_vala_la_CPPFLAGS = $(common_defines)
 
 libsample_vala_la_CFLAGS = \
--- origsrc/totem-2.26.1/src/plugins/screensaver/Makefile.am	2009-03-16 05:40:04.000000000 -0500
+++ src/totem-2.26.1/src/plugins/screensaver/Makefile.am	2009-04-19 17:23:27.436875000 -0500
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/screensaver
 plugin_LTLIBRARIES = libscreensaver.la
@@ -22,7 +22,7 @@ common_defines = \
 
 libscreensaver_la_SOURCES = totem-screensaver.c
 libscreensaver_la_LDFLAGS = $(modules_flags)
-libscreensaver_la_LIBADD = $(top_builddir)/lib/libtotemscrsaver.la
+libscreensaver_la_LIBADD = $(top_builddir)/lib/libtotemscrsaver.la $(top_builddir)/src/backend/libbaconvideowidget.la
 libscreensaver_la_CPPFLAGS = $(common_defines)
 
 libscreensaver_la_CFLAGS = \
--- origsrc/totem-2.26.1/src/plugins/screenshot/Makefile.am	2009-03-16 05:40:04.000000000 -0500
+++ src/totem-2.26.1/src/plugins/screenshot/Makefile.am	2009-04-19 21:29:41.702500000 -0500
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/screenshot
 uidir = $(plugindir)
@@ -32,6 +32,7 @@ libscreenshot_la_SOURCES = \
 	totem-gallery-progress.c	\
 	totem-gallery-progress.h
 libscreenshot_la_LDFLAGS = $(modules_flags)
+libscreenshot_la_LIBADD = $(top_builddir)/src/backend/libbaconvideowidget.la $(GTK_LIBS)
 libscreenshot_la_CPPFLAGS = \
 	$(common_defines)		\
 	-I$(top_srcdir)/src/backend	\
--- origsrc/totem-2.26.1/src/plugins/sidebar-test/Makefile.am	2009-03-16 05:40:03.000000000 -0500
+++ src/totem-2.26.1/src/plugins/sidebar-test/Makefile.am	2009-04-19 17:23:27.546250000 -0500
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/sidebar-test
 plugin_LTLIBRARIES = libsidebar-test.la
@@ -24,6 +24,7 @@ common_defines = \
 
 libsidebar_test_la_SOURCES = totem-sidebar-test.c
 libsidebar_test_la_LDFLAGS = $(modules_flags)
+libsidebar_test_la_LIBADD = $(GTK_LIBS)
 libsidebar_test_la_CPPFLAGS = $(common_defines)
 
 libsidebar_test_la_CFLAGS = \
--- origsrc/totem-2.26.1/src/plugins/skipto/Makefile.am	2009-03-16 05:40:04.000000000 -0500
+++ src/totem-2.26.1/src/plugins/skipto/Makefile.am	2009-04-19 17:23:27.561875000 -0500
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/skipto
 uidir = $(plugindir)
@@ -30,6 +30,7 @@ libskipto_la_SOURCES = \
 	totem-skipto.c		\
 	totem-skipto.h
 libskipto_la_LDFLAGS = $(modules_flags)
+libskipto_la_LIBADD = $(top_builddir)/src/backend/libbaconvideowidget.la $(GTK_LIBS)
 libskipto_la_CPPFLAGS = \
 	$(common_defines)		\
 	-I$(top_srcdir)/src/backend	\
--- origsrc/totem-2.26.1/src/plugins/thumbnail/Makefile.am	2009-03-16 05:40:03.000000000 -0500
+++ src/totem-2.26.1/src/plugins/thumbnail/Makefile.am	2009-04-19 17:23:27.655625000 -0500
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/thumbnail
 plugin_LTLIBRARIES = libthumbnail.la
@@ -22,7 +22,7 @@ common_defines = \
 
 libthumbnail_la_SOURCES = totem-thumbnail.c
 libthumbnail_la_LDFLAGS = $(modules_flags)
-libthumbnail_la_LIBADD = 
+libthumbnail_la_LIBADD = $(GTK_LIBS)
 libthumbnail_la_CPPFLAGS = $(common_defines)
 
 libthumbnail_la_CFLAGS = \
--- origsrc/totem-2.26.1/src/plugins/tracker/Makefile.am	2009-03-16 05:40:04.000000000 -0500
+++ src/totem-2.26.1/src/plugins/tracker/Makefile.am	2009-04-19 17:23:27.733750000 -0500
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/tracker
 plugin_LTLIBRARIES = libtracker.la

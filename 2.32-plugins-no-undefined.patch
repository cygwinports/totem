--- origsrc/totem-2.32.0/configure.in	2010-09-27 07:41:55.000000000 -0500
+++ src/totem-2.32.0/configure.in	2010-12-16 06:21:04.813036100 -0600
@@ -571,10 +571,10 @@ for plugin in ${used_plugins}; do
 			fi
 		;;
 		chapters)
-			PKG_CHECK_MODULES(CHAPTERS, libxml-2.0 >= 2.6.0 gtk+-2.0 glib-2.0 >= 2.15.0,
+			PKG_CHECK_MODULES(CHAPTERS, libxml-2.0 >= 2.6.0 gconf-2.0 gtk+-2.0 glib-2.0 >= 2.15.0,
 				[BUILD_CHAPTERS=yes], [BUILD_CHAPTERS=no])
 			if test "${BUILD_CHAPTERS}" != "yes" ; then
-				plugin_error_or_ignore "you need gtk+-2.0, glib-2.0 >= 2.15.0 and libxml-2.0 >= 2.6.0 to use the chapters plugin"
+				plugin_error_or_ignore "you need gtk+-2.0, gconf-2.0 glib-2.0 >= 2.15.0 and libxml-2.0 >= 2.6.0 to use the chapters plugin"
 				add_plugin="0"
 			fi
 		;;
@@ -807,6 +807,22 @@ AC_SUBST([AM_CFLAGS])
 AC_SUBST([AM_CXXFLAGS])
 AC_SUBST([AM_LDFLAGS])
 
+dnl ================================================================
+dnl Win32 plugin support
+dnl ================================================================
+case "$host_os" in
+	cygwin*|mingw*)
+		platform_win32=yes
+		win32_plugin_ldflags="-no-undefined -Wl,\$(top_builddir)/src/libtotem.a"
+		;;
+	*)
+		platform_win32=no
+		win32_plugin_ldflags=
+		;;
+esac
+AM_CONDITIONAL(PLATFORM_WIN32, test "x$platform_win32" = "xyes")
+AC_SUBST(win32_plugin_ldflags)
+
 AC_OUTPUT([
 Makefile
 totem.spec
--- origsrc/totem-2.32.0/lib/Makefile.am	2010-09-27 07:34:31.000000000 -0500
+++ src/totem-2.32.0/lib/Makefile.am	2010-12-16 05:30:46.003217500 -0600
@@ -27,6 +27,7 @@ libtotemscrsaver_la_LDFLAGS =				\
 	$(AM_LDFLAGS)
 
 libtotemscrsaver_la_LIBADD =				\
+	$(GTK_LIBS)						\
 	$(DBUS_LIBS)					\
 	$(XTEST_LIBS)
 
--- origsrc/totem-2.32.0/src/Makefile.am	2010-09-27 07:34:41.000000000 -0500
+++ src/totem-2.32.0/src/Makefile.am	2010-12-16 05:30:46.003217500 -0600
@@ -1,4 +1,4 @@
-SUBDIRS = plugins backend
+SUBDIRS = backend . plugins
 
 bin_PROGRAMS = totem totem-video-thumbnailer totem-video-indexer totem-audio-preview
 libexec_PROGRAMS =
@@ -17,7 +17,7 @@ common_defines = \
 	-DGTKBUILDERDIR=\"""\"				\
 	$(DISABLE_DEPRECATED)
 
-modules_flags = -export_dynamic -avoid-version -module -no-undefined
+modules_flags = -export-dynamic -avoid-version -module -no-undefined
 
 # Totem UI ltlibrary (used by browser plugins)
 
@@ -187,6 +187,11 @@ totem_CFLAGS =				\
 totem_LDFLAGS = \
 	$(AM_LDFLAGS)
 
+if PLATFORM_WIN32
+totem_LDFLAGS += \
+	-Wl,--export-all-symbols -Wl,--out-implib,libtotem.a
+endif
+
 totem_LDADD =						\
 	libtotem_main.la				\
 	$(DEPENDENCY_LIBS)				\
@@ -291,8 +296,8 @@ test_properties_page_LDFLAGS = \
 	$(AM_LDFLAGS)
 
 test_properties_page_LDADD = 					\
-	backend/libbaconvideowidget.la				\
 	plugins/properties/libbaconvideowidgetproperties.la	\
+	backend/libbaconvideowidget.la				\
 	libtotem_player.la					\
 	$(DEPENDENCY_LIBS)					\
 	$(NAUTILUS_LIBS)					\
@@ -363,6 +368,12 @@ totem_audio_preview_LDADD = \
 	$(XVIDMODE_LIBS)		\
 	$(X_LIBS)
 
+plugins/libtotemmodule.la:
+	cd $(@D) ; $(MAKE) $(@F)
+
+plugins/properties/libbaconvideowidgetproperties.la:
+	cd $(@D) ; $(MAKE) $(@F)
+
 CLEANFILES =			\
 	*.bak			\
 	core*			\
--- origsrc/totem-2.32.0/src/backend/Makefile.am	2010-09-27 07:34:32.000000000 -0500
+++ src/totem-2.32.0/src/backend/Makefile.am	2010-12-16 05:30:46.013217500 -0600
@@ -57,6 +57,7 @@ libbaconvideowidget_la_LIBADD =	\
 	$(XVIDMODE_LIBS)	\
 	$(MM_LIBS)		\
 	$(GST_LIBS)		\
+	$(GTK_LIBS)		\
 	$(EXTRA_BACKEND_LIBS)	\
 	$(X_LIBS)		\
 	$(MISSING_PLUGINS_LIBS)	\
--- origsrc/totem-2.32.0/src/plugins/bemused/Makefile.am	2010-09-27 07:34:32.000000000 -0500
+++ src/totem-2.32.0/src/plugins/bemused/Makefile.am	2010-12-16 05:30:46.013217500 -0600
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/bemused
 plugin_LTLIBRARIES = libbemused.la
--- origsrc/totem-2.32.0/src/plugins/brasero-disc-recorder/Makefile.am	2010-09-27 07:34:32.000000000 -0500
+++ src/totem-2.32.0/src/plugins/brasero-disc-recorder/Makefile.am	2010-12-16 05:30:46.023217500 -0600
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/brasero-disc-recorder
 plugin_LTLIBRARIES = libbrasero-disc-recorder.la
--- origsrc/totem-2.32.0/src/plugins/chapters/Makefile.am	2010-09-27 07:34:32.000000000 -0500
+++ src/totem-2.32.0/src/plugins/chapters/Makefile.am	2010-12-16 06:17:32.645299700 -0600
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/chapters
 plugin_LTLIBRARIES = libchapters.la
--- origsrc/totem-2.32.0/src/plugins/galago/Makefile.am	2010-09-27 07:34:32.000000000 -0500
+++ src/totem-2.32.0/src/plugins/galago/Makefile.am	2010-12-16 05:30:46.023217500 -0600
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/galago
 plugin_LTLIBRARIES = libtgp.la
--- origsrc/totem-2.32.0/src/plugins/gromit/Makefile.am	2010-09-27 07:34:32.000000000 -0500
+++ src/totem-2.32.0/src/plugins/gromit/Makefile.am	2010-12-16 05:30:46.033217500 -0600
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/gromit
 plugin_LTLIBRARIES = libgromit.la
@@ -23,7 +23,7 @@ common_defines = \
 
 libgromit_la_SOURCES = totem-gromit.c
 libgromit_la_LDFLAGS = $(modules_flags)
-libgromit_la_LIBADD = 
+libgromit_la_LIBADD = $(DBUS_LIBS)
 libgromit_la_CPPFLAGS = $(common_defines)
 
 libgromit_la_CFLAGS = \
--- origsrc/totem-2.32.0/src/plugins/lirc/Makefile.am	2010-09-27 07:34:32.000000000 -0500
+++ src/totem-2.32.0/src/plugins/lirc/Makefile.am	2010-12-16 05:30:46.033217500 -0600
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/lirc
 plugin_LTLIBRARIES = liblirc.la
--- origsrc/totem-2.32.0/src/plugins/media-player-keys/Makefile.am	2010-09-27 07:34:32.000000000 -0500
+++ src/totem-2.32.0/src/plugins/media-player-keys/Makefile.am	2010-12-16 05:30:46.043217500 -0600
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/media-player-keys
 plugin_LTLIBRARIES = libmedia_player_keys.la
--- origsrc/totem-2.32.0/src/plugins/ontop/Makefile.am	2010-09-27 07:34:32.000000000 -0500
+++ src/totem-2.32.0/src/plugins/ontop/Makefile.am	2010-12-16 05:30:46.043217500 -0600
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/ontop
 plugin_LTLIBRARIES = libontop.la
--- origsrc/totem-2.32.0/src/plugins/properties/Makefile.am	2010-09-27 07:34:32.000000000 -0500
+++ src/totem-2.32.0/src/plugins/properties/Makefile.am	2010-12-16 05:30:46.053217500 -0600
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/properties
 plugin_LTLIBRARIES = libmovie-properties.la
@@ -25,7 +25,7 @@ common_defines = \
 
 libmovie_properties_la_SOURCES = totem-movie-properties.c
 libmovie_properties_la_LDFLAGS = $(modules_flags)
-libmovie_properties_la_LIBADD = libbaconvideowidgetproperties.la
+libmovie_properties_la_LIBADD = libbaconvideowidgetproperties.la $(GTK_LIBS)
 libmovie_properties_la_CPPFLAGS = $(common_defines)
 
 libmovie_properties_la_CFLAGS = \
--- origsrc/totem-2.32.0/src/plugins/publish/Makefile.am	2010-09-27 07:34:41.000000000 -0500
+++ src/totem-2.32.0/src/plugins/publish/Makefile.am	2010-12-16 05:30:46.063217600 -0600
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/publish
 plugin_LTLIBRARIES = libpublish.la
--- origsrc/totem-2.32.0/src/plugins/sample-vala/Makefile.am	2010-09-27 07:34:32.000000000 -0500
+++ src/totem-2.32.0/src/plugins/sample-vala/Makefile.am	2010-12-16 06:03:29.031481200 -0600
@@ -7,7 +7,7 @@ plugin_in_files = sample-vala.totem-plug
 %.totem-plugin: %.totem-plugin.in $(INTLTOOL_MERGE) $(wildcard $(top_srcdir)/po/*po) ; $(INTLTOOL_MERGE) $(top_srcdir)/po $< $@ -d -u -c $(top_builddir)/po/.intltool-merge-cache
 
 if ENABLE_VALA
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugin_LTLIBRARIES = libsample-vala.la
 # override to _not_ install the test plugins
@@ -32,6 +32,7 @@ libsample_vala_la_SOURCES = \
 	$(libsample_vala_la_VALASOURCES:.vala=.c)
 
 libsample_vala_la_LDFLAGS = $(modules_flags)
+libsample_vala_la_LIBADD = $(DBUS_LIBS)
 libsample_vala_la_CPPFLAGS = $(common_defines)
 
 libsample_vala_la_CFLAGS = \
--- origsrc/totem-2.32.0/src/plugins/screensaver/Makefile.am	2010-09-27 07:34:32.000000000 -0500
+++ src/totem-2.32.0/src/plugins/screensaver/Makefile.am	2010-12-16 05:30:46.073217600 -0600
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/screensaver
 plugin_LTLIBRARIES = libscreensaver.la
@@ -23,7 +23,7 @@ common_defines = \
 
 libscreensaver_la_SOURCES = totem-screensaver.c
 libscreensaver_la_LDFLAGS = $(modules_flags)
-libscreensaver_la_LIBADD = $(top_builddir)/lib/libtotemscrsaver.la
+libscreensaver_la_LIBADD = $(top_builddir)/lib/libtotemscrsaver.la $(SCREENSAVER_LIBS)
 libscreensaver_la_CPPFLAGS = $(common_defines)
 
 libscreensaver_la_CFLAGS = \
--- origsrc/totem-2.32.0/src/plugins/screenshot/Makefile.am	2010-09-27 07:34:32.000000000 -0500
+++ src/totem-2.32.0/src/plugins/screenshot/Makefile.am	2010-12-16 05:30:46.073217600 -0600
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/screenshot
 uidir = $(plugindir)
@@ -35,6 +35,7 @@ libscreenshot_la_SOURCES = \
 	totem-gallery-progress.c	\
 	totem-gallery-progress.h
 libscreenshot_la_LDFLAGS = $(modules_flags)
+libscreenshot_la_LIBADD = $(GTK_LIBS) $(SCREENSAVER_LIBS)
 libscreenshot_la_CPPFLAGS = \
 	$(common_defines)		\
 	-I$(top_srcdir)/src/backend
--- origsrc/totem-2.32.0/src/plugins/sidebar-test/Makefile.am	2010-09-27 07:34:32.000000000 -0500
+++ src/totem-2.32.0/src/plugins/sidebar-test/Makefile.am	2010-12-16 05:30:46.083217600 -0600
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/sidebar-test
 plugin_LTLIBRARIES = libsidebar-test.la
@@ -25,6 +25,7 @@ common_defines = \
 
 libsidebar_test_la_SOURCES = totem-sidebar-test.c
 libsidebar_test_la_LDFLAGS = $(modules_flags)
+libsidebar_test_la_LIBADD = $(GTK_LIBS)
 libsidebar_test_la_CPPFLAGS = $(common_defines)
 
 libsidebar_test_la_CFLAGS = \
--- origsrc/totem-2.32.0/src/plugins/skipto/Makefile.am	2010-09-27 07:34:32.000000000 -0500
+++ src/totem-2.32.0/src/plugins/skipto/Makefile.am	2010-12-16 05:30:46.093217600 -0600
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/skipto
 uidir = $(plugindir)
@@ -31,6 +31,7 @@ libskipto_la_SOURCES = \
 	totem-skipto.c		\
 	totem-skipto.h
 libskipto_la_LDFLAGS = $(modules_flags)
+libskipto_la_LIBADD = $(GTK_LIBS)
 libskipto_la_CPPFLAGS = \
 	$(common_defines)		\
 	-I$(top_srcdir)/src/backend
--- origsrc/totem-2.32.0/src/plugins/thumbnail/Makefile.am	2010-09-27 07:34:32.000000000 -0500
+++ src/totem-2.32.0/src/plugins/thumbnail/Makefile.am	2010-12-16 05:30:46.103217600 -0600
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/thumbnail
 plugin_LTLIBRARIES = libthumbnail.la
@@ -23,7 +23,7 @@ common_defines = \
 
 libthumbnail_la_SOURCES = totem-thumbnail.c
 libthumbnail_la_LDFLAGS = $(modules_flags)
-libthumbnail_la_LIBADD = 
+libthumbnail_la_LIBADD = $(GTK_LIBS)
 libthumbnail_la_CPPFLAGS = $(common_defines)
 
 libthumbnail_la_CFLAGS = \
--- origsrc/totem-2.32.0/src/plugins/tracker/Makefile.am	2010-09-27 07:34:33.000000000 -0500
+++ src/totem-2.32.0/src/plugins/tracker/Makefile.am	2010-12-16 05:30:46.103217600 -0600
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export-dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/tracker
 plugin_LTLIBRARIES = libtracker.la
--- origsrc/totem-2.32.0/src/plugins/youtube/Makefile.am	2010-09-27 07:34:33.000000000 -0500
+++ src/totem-2.32.0/src/plugins/youtube/Makefile.am	2010-12-16 05:31:19.574362100 -0600
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export_dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/youtube
 plugin_LTLIBRARIES = libyoutube.la
@@ -27,6 +27,7 @@ common_defines = \
 libyoutube_la_SOURCES = totem-youtube.c
 libyoutube_la_LDFLAGS = $(modules_flags)
 libyoutube_la_LIBADD = \
+	$(GTK_LIBS)		\
 	$(LIBGDATA_LIBS)	\
 	$(LIBSOUP_LIBS)
 libyoutube_la_CPPFLAGS = $(common_defines)

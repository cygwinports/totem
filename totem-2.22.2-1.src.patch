--- origsrc/totem-2.22.2/configure.in	2008-04-24 04:53:49.000000000 -0500
+++ src/totem-2.22.2/configure.in	2008-06-04 18:03:26.453125000 -0500
@@ -317,7 +317,7 @@
 EOF
 
 	if /bin/sh ../libtool --mode=compile ${CC} $PYTHON_CFLAGS -c testpython.c >/dev/null 2>&1 && \
-		/bin/sh ../libtool --mode=link ${CC} -o testpython.la -rpath `pwd` -module -avoid-version $PYTHON_LIB_LOC testpython.lo $PYTHON_LIBS $PYTHON_EXTRA_LIBS >/dev/null 2>&1 && \
+		/bin/sh ../libtool --mode=link ${CC} -o testpython.la -rpath `pwd` -module -avoid-version -no-undefined $PYTHON_LIB_LOC testpython.lo $PYTHON_LIBS $PYTHON_EXTRA_LIBS >/dev/null 2>&1 && \
 		grep 'dlname.*testpython' testpython.la >/dev/null 2>&1; then
 		result=yes
 	else
@@ -1031,6 +1031,22 @@
 AC_SUBST([AM_CXXFLAGS])
 AC_SUBST([AM_LDFLAGS])
 
+dnl ================================================================
+dnl Win32 plugin support
+dnl ================================================================
+case "$host_os" in
+	cygwin*|mingw*)
+		platform_win32=yes
+		win32_plugin_ldflags="-no-undefined -Wl,\$(top_builddir)/src/libtotem.a"
+		;;
+	*)
+		platform_win32=no
+		win32_plugin_ldflags=
+		;;
+esac
+AM_CONDITIONAL(PLATFORM_WIN32, test "x$platform_win32" = "xyes")
+AC_SUBST(win32_plugin_ldflags)
+
 AC_OUTPUT([
 Makefile
 totem.spec
--- origsrc/totem-2.22.2/lib/Makefile.am	2008-03-04 11:20:04.000000000 -0600
+++ src/totem-2.22.2/lib/Makefile.am	2008-06-03 09:10:46.250000000 -0500
@@ -27,6 +27,7 @@
 	$(AM_LDFLAGS)
 
 libtotemscrsaver_la_LIBADD =				\
+	$(GTK_LIBS)						\
 	$(DBUS_LIBS)					\
 	$(XTEST_LIBS)
 
--- origsrc/totem-2.22.2/src/Makefile.am	2008-03-04 11:20:03.000000000 -0600
+++ src/totem-2.22.2/src/Makefile.am	2008-06-03 09:10:46.265625000 -0500
@@ -1,4 +1,4 @@
-SUBDIRS = plugins backend
+SUBDIRS = backend . plugins
 
 bin_PROGRAMS = totem totem-video-thumbnailer totem-video-indexer totem-audio-preview
 libexec_PROGRAMS =
@@ -41,6 +41,11 @@
 libbaconmessageconnection_la_LDFLAGS = \
 	$(AM_LDFLAGS)
 
+plugins/libtotemmodule.la:
+	cd $(@D) ; $(MAKE) $(@F)
+
+plugins/properties/libbaconvideowidgetproperties.la:
+	cd $(@D) ; $(MAKE) $(@F)
 
 EGGDIR=$(srcdir)/../../libegg/libegg/recent-files/
 BACONDIR=$(srcdir)/../../libbacon/src
@@ -138,6 +143,11 @@
 totem_LDFLAGS = \
 	$(AM_LDFLAGS)
 
+if PLATFORM_WIN32
+totem_LDFLAGS += \
+	-Wl,--export-all-symbols -Wl,--out-implib,libtotem.a
+endif
+
 totem_LDADD =						\
 	backend/libbaconvideowidget.la			\
 	plugins/libtotemmodule.la			\
--- origsrc/totem-2.22.2/src/plugins/galago/Makefile.am	2008-03-04 11:20:02.000000000 -0600
+++ src/totem-2.22.2/src/plugins/galago/Makefile.am	2008-06-03 09:10:46.281250000 -0500
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export_dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/galago
 plugin_LTLIBRARIES = libtgp.la
--- origsrc/totem-2.22.2/src/plugins/gromit/Makefile.am	2008-03-04 11:20:03.000000000 -0600
+++ src/totem-2.22.2/src/plugins/gromit/Makefile.am	2008-06-03 09:10:46.296875000 -0500
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export_dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/gromit
 plugin_LTLIBRARIES = libgromit.la
@@ -22,7 +22,7 @@
 
 libgromit_la_SOURCES = totem-gromit.c
 libgromit_la_LDFLAGS = $(modules_flags)
-libgromit_la_LIBADD = 
+libgromit_la_LIBADD = $(DBUS_LIBS)
 libgromit_la_CPPFLAGS = $(common_defines)
 
 libgromit_la_CFLAGS = \
--- origsrc/totem-2.22.2/src/plugins/lirc/Makefile.am	2008-03-04 11:20:02.000000000 -0600
+++ src/totem-2.22.2/src/plugins/lirc/Makefile.am	2008-06-03 09:10:46.296875000 -0500
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export_dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/lirc
 plugin_LTLIBRARIES = liblirc.la
--- origsrc/totem-2.22.2/src/plugins/media-player-keys/Makefile.am	2008-03-04 11:20:02.000000000 -0600
+++ src/totem-2.22.2/src/plugins/media-player-keys/Makefile.am	2008-06-03 09:10:46.328125000 -0500
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export_dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/media-player-keys
 plugin_LTLIBRARIES = libmedia_player_keys.la
--- origsrc/totem-2.22.2/src/plugins/ontop/Makefile.am	2008-03-04 11:20:03.000000000 -0600
+++ src/totem-2.22.2/src/plugins/ontop/Makefile.am	2008-06-03 09:10:46.343750000 -0500
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export_dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/ontop
 plugin_LTLIBRARIES = libontop.la
--- origsrc/totem-2.22.2/src/plugins/properties/Makefile.am	2008-03-04 11:20:03.000000000 -0600
+++ src/totem-2.22.2/src/plugins/properties/Makefile.am	2008-06-03 09:10:46.359375000 -0500
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export_dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/properties
 plugin_LTLIBRARIES = libmovie-properties.la
@@ -24,7 +24,7 @@
 
 libmovie_properties_la_SOURCES = totem-movie-properties.c
 libmovie_properties_la_LDFLAGS = $(modules_flags)
-libmovie_properties_la_LIBADD = libbaconvideowidgetproperties.la
+libmovie_properties_la_LIBADD = libbaconvideowidgetproperties.la $(GTK_LIBS)
 libmovie_properties_la_CPPFLAGS = $(common_defines)
 
 libmovie_properties_la_CFLAGS = \
--- origsrc/totem-2.22.2/src/plugins/publish/Makefile.am	2008-03-04 11:20:03.000000000 -0600
+++ src/totem-2.22.2/src/plugins/publish/Makefile.am	2008-06-03 09:11:46.265625000 -0500
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export_dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/publish
 plugin_LTLIBRARIES = libpublish.la
--- origsrc/totem-2.22.2/src/plugins/sample-vala/Makefile.am	2008-03-04 11:20:03.000000000 -0600
+++ src/totem-2.22.2/src/plugins/sample-vala/Makefile.am	2008-06-04 09:39:05.453125000 -0500
@@ -7,14 +7,14 @@
 %.totem-plugin: %.totem-plugin.in $(INTLTOOL_MERGE) $(wildcard $(top_srcdir)/po/*po) ; $(INTLTOOL_MERGE) $(top_srcdir)/po $< $@ -d -u -c $(top_builddir)/po/.intltool-merge-cache
 
 if ENABLE_VALA
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export_dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugin_LTLIBRARIES = libsample-vala.la
 # override to _not_ install the test plugins
 install-pluginLTLIBRARIES:
 
 totem-sample-vala-plugin.c totem-sample-vala-plugin.h: totem-sample-vala-plugin.vala
-	$(VALAC) --vapidir=$(top_srcdir)/bindings/vala --pkg=totem $^
+	$(VALAC) -C --vapidir=$(top_srcdir)/bindings/vala --pkg=totem $^
 
 common_defines = \
 	-D_REENTRANT					\
@@ -29,6 +29,7 @@
 
 nodist_libsample_vala_la_SOURCES = $(BUILT_SOURCES)
 libsample_vala_la_LDFLAGS = $(modules_flags)
+libsample_vala_la_LIBADD = $(VALA_LIBS)
 libsample_vala_la_CPPFLAGS = $(common_defines)
 
 libsample_vala_la_CFLAGS = \
--- origsrc/totem-2.22.2/src/plugins/screensaver/Makefile.am	2008-03-04 11:20:02.000000000 -0600
+++ src/totem-2.22.2/src/plugins/screensaver/Makefile.am	2008-06-03 09:10:46.390625000 -0500
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export_dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/screensaver
 plugin_LTLIBRARIES = libscreensaver.la
--- origsrc/totem-2.22.2/src/plugins/sidebar-test/Makefile.am	2008-03-04 11:20:02.000000000 -0600
+++ src/totem-2.22.2/src/plugins/sidebar-test/Makefile.am	2008-06-03 09:10:46.406250000 -0500
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export_dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/sidebar-test
 plugin_LTLIBRARIES = libsidebar-test.la
@@ -24,6 +24,7 @@
 
 libsidebar_test_la_SOURCES = totem-sidebar-test.c
 libsidebar_test_la_LDFLAGS = $(modules_flags)
+libsidebar_test_la_LIBADD = $(GTK_LIBS)
 libsidebar_test_la_CPPFLAGS = $(common_defines)
 
 libsidebar_test_la_CFLAGS = \
--- origsrc/totem-2.22.2/src/plugins/skipto/Makefile.am	2008-03-04 11:20:03.000000000 -0600
+++ src/totem-2.22.2/src/plugins/skipto/Makefile.am	2008-06-03 09:10:46.421875000 -0500
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export_dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/skipto
 uidir = $(plugindir)
@@ -28,6 +28,7 @@
 	totem-skipto.c		\
 	totem-skipto.h
 libskipto_la_LDFLAGS = $(modules_flags)
+libskipto_la_LIBADD = $(GTK_LIBS)
 libskipto_la_CPPFLAGS = \
 	$(common_defines)		\
 	-I$(top_srcdir)/src/backend	\
--- origsrc/totem-2.22.2/src/plugins/thumbnail/Makefile.am	2008-03-04 11:20:02.000000000 -0600
+++ src/totem-2.22.2/src/plugins/thumbnail/Makefile.am	2008-06-03 09:13:04.968750000 -0500
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export_dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/thumbnail
 plugin_LTLIBRARIES = libthumbnail.la
@@ -22,7 +22,7 @@
 
 libthumbnail_la_SOURCES = totem-thumbnail.c
 libthumbnail_la_LDFLAGS = $(modules_flags)
-libthumbnail_la_LIBADD = 
+libthumbnail_la_LIBADD = $(GTK_LIBS)
 libthumbnail_la_CPPFLAGS = $(common_defines)
 
 libthumbnail_la_CFLAGS = \
--- origsrc/totem-2.22.2/src/plugins/tracker/Makefile.am	2008-03-04 11:20:03.000000000 -0600
+++ src/totem-2.22.2/src/plugins/tracker/Makefile.am	2008-06-03 09:12:21.843750000 -0500
@@ -1,4 +1,4 @@
-modules_flags = -export_dynamic -avoid-version -module
+modules_flags = -export_dynamic -avoid-version -module $(win32_plugin_ldflags)
 
 plugindir = $(PLUGINDIR)/tracker
 plugin_LTLIBRARIES = libtracker.la
